trigger ContactTrigger on Contact (before insert) {
    Set<String> emailSet = new Set<String>();
    
    // Collect all emails from incoming records
    for (Contact con : Trigger.new) {
        if (con.Email != null) {
            emailSet.add(con.Email.toLowerCase()); // case-insensitive
        }
    }
    
    // Query existing contacts with those emails
    Set<String> existingEmails = new Set<String>();
    for (Contact con : [
        SELECT Email 
        FROM Contact 
        WHERE Email IN :emailSet
    ]) {
        if (con.Email != null) {
            existingEmails.add(con.Email.toLowerCase());
        }
    }
    
    // Track duplicates within the same transaction
    Set<String> newEmailsSeen = new Set<String>();
    
    // Validate
    for (Contact con : Trigger.new) {
        if (con.Email != null) {
            String emailLower = con.Email.toLowerCase();
            
            // Check against DB
            if (existingEmails.contains(emailLower)) {
                con.addError('A contact with this email already exists: ' + con.Email);
            }
            
            // Check against other new contacts in same transaction
            else if (!newEmailsSeen.add(emailLower)) {
                con.addError('Duplicate email within the same request: ' + con.Email);
            }
        }
    }
}
